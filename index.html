<!DOCTYPE html>
<html>
    <head>
        <script src="https://unpkg.com/aubiojs"></script>
        <script>

        let recordButton 
        let frequencyEl
        let maxWeightEl
        let pd 

        window.addEventListener("load", evt => {
            recordButton = document.getElementById("record");
            frequencyEl = document.getElementById("frequency");
            maxWeightEl = document.getElementById("maxWeight");

            pd = new PitchDetector();

            recordButton.addEventListener("click", pd.startRecord.bind(pd))
        })

        const pitchMethods = ["default","schmitt", "fcomb", "mcomb", "specacf", "yin", "yinfft", "yinfast"]

        class PitchDetector  {

            #audioContext;
            #analyser;
            #scriptProcessor;
            #bufferSize = 4096;
            #aubioPitch;


            constructor( ) {  
                this.normalizeGetUserMedia();
                this.#audioContext = new window.AudioContext();
                this.#analyser = this.#audioContext.createAnalyser();
                this.#scriptProcessor = this.#audioContext.createScriptProcessor(
                    this.#bufferSize,
                    1,
                    1
                );
                aubio().then(({ Pitch }) => {
                    this.#aubioPitch = new Pitch(
                        pitchMethods[0],
                        this.#scriptProcessor.bufferSize * 4, // winsize
                        this.#scriptProcessor.bufferSize, // stepsize
                        this.#audioContext.sampleRate // samplerate
                    )
                });
            }

            startRecord() {
                navigator.mediaDevices
                    .getUserMedia({ audio: true })
                    .then(stream => {
                        this.#audioContext.createMediaStreamSource(stream).connect(this.#analyser);
                        this.#analyser.connect(this.#scriptProcessor);
                        this.#scriptProcessor.connect(this.#audioContext.destination);
                        this.#scriptProcessor.addEventListener("audioprocess", (event) => {
                            const data = event.inputBuffer.getChannelData(0)
                            const frequency = this.#aubioPitch.do(data);
                            frequencyEl.innerHTML = frequency;
                        });
                    })
                    .catch(function (error) {
                        alert(error.name + ": " + error.message);
                    });
            };
            
            normalizeGetUserMedia() {

                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!window.AudioContext) {
                    return alert("AudioContext not supported");
                }

                // Older browsers might not implement mediaDevices at all, so we set an empty object first
                if (navigator.mediaDevices === undefined) {
                    navigator.mediaDevices = {};
                }

                // Some browsers partially implement mediaDevices. We can't just assign an object
                // with getUserMedia as it would overwrite existing properties.
                // Here, we will just add the getUserMedia property if it's missing.
                if (navigator.mediaDevices.getUserMedia === undefined) {
                    navigator.mediaDevices.getUserMedia = function (constraints) {
                    // First get ahold of the legacy getUserMedia, if present
                    const getUserMedia =
                        navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

                    // Some browsers just don't implement it - return a rejected promise with an error
                    // to keep a consistent interface
                    if (!getUserMedia) {
                        alert("getUserMedia is not implemented in this browser");
                    }

                    // Otherwise, wrap the call to the old navigator.getUserMedia with a Promise
                    return new Promise(function (resolve, reject) {
                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                    };
                }   
            }
        }
        </script>
    </head>
<body>
    
    <button id="record">Record the Song of Ice</button>

    <div id="frequency"></div>
    <div id="maxWeight"></div>

</body>
</html>